<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>C2 Dashboard</title>
  <link rel="stylesheet" href="../static/css/styles.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <div class="page-container">
    <div class="head-bar">
      <h1 id="head-bar-header">Available Machines (Tier {{ tier_id }})</h1>
      <div class="head-bar-buttons">
        {% if user and user.is_admin %}
        <button type="button" id="admin-button" onclick="window.location.href='{{ url_for('admin_dashboard') }}';">Admin</button>
        {% endif %}
        <form action="{{ url_for('logout') }}" method="POST" style="display:inline;">
          <button type="submit" id="sign-out-button" class="btn">Sign Out</button>
        </form>
      </div>
    </div>

    <div class="machines-container manage-machines">
      <h2 class="section-header">Active Machines</h2>
      <div id="machines-list">
        <table class="machines-table">
          <thead>
            <tr>
              <th>MachineID</th>
              <th>IP</th>
              <th>OS</th>
              <th>Version</th>
              <th>Check In</th>
              <th>Cores</th>
              <th>RAM (GB)</th>
              <th>Tasks</th>
            </tr>
          </thead>
          <tbody id="active-machines-body">
            <!-- This will be populated by JavaScript -->
          </tbody>
        </table>
      </div>

      <h2 class="section-header">Inactive Machines</h2>
      <div class="table-responsive">
        <table class="machines-table">
          <thead>
            <tr>
              <th>MachineID</th>
              <th>IP</th>
              <th>OS</th>
              <th>Version</th>
              <th>Check In</th>
              <th>Cores</th>
              <th>RAM (GB)</th>
              <th>Tasks</th>
            </tr>
          </thead>
          <tbody id="inactive-machines-body">
            <!-- This will be populated by JavaScript -->
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <script>
    // Fetch machines when page loads
    document.addEventListener('DOMContentLoaded', function() {
      fetch('/displayagents')
        .then(response => response.json())
        .then(machines => {
          const activeTableBody = document.getElementById('active-machines-body');
          const inactiveTableBody = document.getElementById('inactive-machines-body');
          activeTableBody.innerHTML = ''; // Clear existing content
          inactiveTableBody.innerHTML = ''; // Clear existing content

          if (machines.length === 0) {
            activeTableBody.innerHTML = '<tr><td colspan="8">No machines found.</td></tr>';
            inactiveTableBody.innerHTML = '<tr><td colspan="8">No machines found.</td></tr>';
            return;
          }

          // Current time to determine active/inactive (machines older than 24 hours are inactive)
          const now = new Date();
          const oneDayAgo = new Date(now.getTime() - (24 * 60 * 60 * 1000));

          // Sort and display machines
          machines.forEach(machine => {
            const lastCheckin = new Date(machine.LastCheckin);
            const isActive = lastCheckin > oneDayAgo;

            const tr = document.createElement('tr');
            tr.innerHTML = `
              <td>${machine.ID}</td>
              <td>${machine.IPAddress}</td>
              <td>${machine.Os}</td>
              <td>${machine.OsVersion || ''}</td>
              <td>${formatDate(machine.LastCheckin)}</td>
              <td>${machine.Cores}</td>
              <td>${machine.Ram}</td>
              <td>${formatTasks(machine.Tasks)}</td>
            `;

            if (isActive) {
              activeTableBody.appendChild(tr);
            } else {
              inactiveTableBody.appendChild(tr);
            }
          });
        })
        .catch(error => {
          console.error('Error fetching machines:', error);
          document.getElementById('active-machines-body').innerHTML =
            '<tr><td colspan="8">Error loading machines. Please try again.</td></tr>';
          document.getElementById('inactive-machines-body').innerHTML =
            '<tr><td colspan="8">Error loading machines. Please try again.</td></tr>';
        });
    });

    // Helper function to format date
    function formatDate(dateString) {
      const date = new Date(dateString);
      return date.toLocaleDateString() + ', ' +
             date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
    }

    // Helper function to format tasks
    function formatTasks(tasks) {
      if (!tasks || tasks.length === 0) {
        return 'No tasks';
      }

      return tasks.map(task => task.Description).join('<br>');
    }
  </script>
</body>
</html>